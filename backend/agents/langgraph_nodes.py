"""
LangGraphèŠ‚ç‚¹å®šä¹‰
æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œè§„åˆ’ä»£ç†
"""

import asyncio
from typing import Dict, Any
from datetime import datetime
from langchain.schema import HumanMessage, SystemMessage
from langchain.tools import BaseTool
from loguru import logger

from .langgraph_state import TravelPlanState, AgentResult, TravelRequest
from .langgraph_tools import get_all_tools
from config.llm import get_qwen_model


class LangGraphNode:
    """LangGraphèŠ‚ç‚¹åŸºç±»"""
    
    def __init__(self, name: str, description: str, tools: list = None):
        self.name = name
        self.description = description
        self.tools = tools or []
        self.model = get_qwen_model(temperature=0.3, max_tokens=4096)
    
    async def execute(self, state: TravelPlanState) -> Dict[str, Any]:
        """æ‰§è¡ŒèŠ‚ç‚¹é€»è¾‘"""
        start_time = datetime.now()
        
        try:
            logger.info(f"å¼€å§‹æ‰§è¡ŒèŠ‚ç‚¹: {self.name}")
            
            # æ„å»ºæç¤ºè¯
            prompt = self._build_prompt(state)
            
            # è°ƒç”¨æ¨¡å‹
            response = await self.model.ainvoke([HumanMessage(content=prompt)])
            
            # å¤„ç†å“åº”
            if hasattr(response, 'content'):
                final_response = response.content
            else:
                final_response = str(response)
            
            execution_time = (datetime.now() - start_time).total_seconds()
            
            # åˆ›å»ºç»“æœ
            result = AgentResult(
                agent_name=self.name,
                content=final_response,
                status="completed",
                execution_time=execution_time,
                timestamp=datetime.now()
            )
            
            logger.info(f"èŠ‚ç‚¹ {self.name} æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶: {execution_time:.2f}ç§’")
            
            # æ ¹æ®èŠ‚ç‚¹ç±»å‹æ˜ å°„åˆ°æ­£ç¡®çš„çŠ¶æ€å­—æ®µ
            result_key = self._get_result_key()
            
            return {
                result_key: result,
                "current_step": self.name,
                "completed_steps": state.get("completed_steps", []) + [self.name]
            }
            
        except Exception as e:
            execution_time = (datetime.now() - start_time).total_seconds()
            logger.error(f"èŠ‚ç‚¹ {self.name} æ‰§è¡Œå¤±è´¥: {e}")
            
            result = AgentResult(
                agent_name=self.name,
                content=f"æ‰§è¡Œå¤±è´¥: {str(e)}",
                status="failed",
                error_message=str(e),
                execution_time=execution_time,
                timestamp=datetime.now()
            )
            
            return {
                f"{self.name.lower().replace(' ', '_')}_result": result,
                "failed_steps": state.get("failed_steps", []) + [self.name]
            }
    
    def _build_prompt(self, state: TravelPlanState) -> str:
        """æ„å»ºèŠ‚ç‚¹æç¤ºè¯"""
        travel_request = state["travel_request"]
        
        base_prompt = f"""
        æ‚¨æ˜¯{self.name}ï¼Œ{self.description}
        
        ç”¨æˆ·æ—…è¡Œè¯·æ±‚ï¼š
        - ç›®çš„åœ°: {travel_request.destination}
        - å‡ºå‘åœ°: {travel_request.starting_location}
        - æ—…è¡Œæ—¥æœŸ: {travel_request.travel_dates_start} åˆ° {travel_request.travel_dates_end}
        - æŒç»­æ—¶é—´: {travel_request.duration}å¤©
        - æ—…è¡Œäººæ•°: {travel_request.adults}ä¸ªæˆäºº, {travel_request.children}ä¸ªå„¿ç«¥
        - é¢„ç®—: {travel_request.budget} {travel_request.budget_currency}
        - æ—…è¡Œé£æ ¼: {travel_request.travel_style}
        - æ—…è¡Œæ°›å›´: {', '.join(travel_request.vibes)}
        - ä¼˜å…ˆçº§: {', '.join(travel_request.priorities)}
        - å…´è¶£: {travel_request.interests}
        - é¢å¤–ä¿¡æ¯: {travel_request.additional_info}
        
        è¯·æ ¹æ®æ‚¨çš„ä¸“ä¸šé¢†åŸŸï¼Œä¸ºç”¨æˆ·æä¾›è¯¦ç»†çš„å»ºè®®å’Œæ¨èã€‚
        è¯·ä½¿ç”¨ä¸­æ–‡å›å¤ï¼Œå†…å®¹è¦è¯¦ç»†ã€å®ç”¨ã€ä¸ªæ€§åŒ–ã€‚
        """
        
        return base_prompt
    
    def _get_result_key(self) -> str:
        """è·å–ç»“æœé”®å"""
        # æ ¹æ®èŠ‚ç‚¹ç±»å‹æ˜ å°„åˆ°çŠ¶æ€å­—æ®µ
        key_mapping = {
            "ç›®çš„åœ°æ¢ç´¢è€…": "destination_result",
            "èˆªç­æœç´¢åŠ©æ‰‹": "flight_result", 
            "é…’åº—æœç´¢åŠ©æ‰‹": "hotel_result",
            "ç¾é£ŸæŒ‡å—": "dining_result",
            "è¡Œç¨‹ä¸“å®¶": "itinerary_result",
            "é¢„ç®—ä¼˜åŒ–å™¨": "budget_result"
        }
        return key_mapping.get(self.name, f"{self.name.lower().replace(' ', '_')}_result")
    


# åˆ›å»ºå„ä¸ªä¸“ä¸šèŠ‚ç‚¹
class DestinationNode(LangGraphNode):
    """ç›®çš„åœ°æ¢ç´¢èŠ‚ç‚¹"""
    
    def __init__(self):
        tools = get_all_tools(["web_search", "attraction_search", "weather_search"])
        super().__init__(
            name="ç›®çš„åœ°æ¢ç´¢è€…",
            description="æ‚¨æ˜¯ä¸€ä¸ªç›®çš„åœ°ç ”ç©¶ä»£ç†ï¼Œä¸“æ³¨äºæ¨èä¸»æµæ—…æ¸¸æ™¯ç‚¹å’Œå¤§å¤šæ•°æ—…è¡Œè€…ä¼šå–œæ¬¢çš„ç»å…¸ä½“éªŒã€‚æ‚¨ä¼˜å…ˆè€ƒè™‘çŸ¥ååœ°æ ‡å’Œçƒ­é—¨æ´»åŠ¨ï¼ŒåŒæ—¶ä¿æŒæ¨èçš„ä¸€èˆ¬æ€§å’Œå¹¿æ³›å¸å¼•åŠ›ã€‚",
            tools=tools
        )
    
    def _build_prompt(self, state: TravelPlanState) -> str:
        """æ„å»ºç›®çš„åœ°æ¢ç´¢æç¤ºè¯"""
        travel_request = state["travel_request"]
        
        base_prompt = f"""
        æ‚¨æ˜¯ç›®çš„åœ°æ¢ç´¢è€…ï¼Œä¸“æ³¨äºæ¨èä¸»æµæ—…æ¸¸æ™¯ç‚¹å’Œå¤§å¤šæ•°æ—…è¡Œè€…ä¼šå–œæ¬¢çš„ç»å…¸ä½“éªŒã€‚
        
        ç”¨æˆ·æ—…è¡Œè¯·æ±‚ï¼š
        - ç›®çš„åœ°: {travel_request.destination}
        - å‡ºå‘åœ°: {travel_request.starting_location}
        - æ—…è¡Œæ—¥æœŸ: {travel_request.travel_dates_start} åˆ° {travel_request.travel_dates_end}
        - æŒç»­æ—¶é—´: {travel_request.duration}å¤©
        - æ—…è¡Œäººæ•°: {travel_request.adults}ä¸ªæˆäºº, {travel_request.children}ä¸ªå„¿ç«¥
        - é¢„ç®—: {travel_request.budget} {travel_request.budget_currency}
        - æ—…è¡Œé£æ ¼: {travel_request.travel_style}
        - æ—…è¡Œæ°›å›´: {', '.join(travel_request.vibes)}
        - ä¼˜å…ˆçº§: {', '.join(travel_request.priorities)}
        - å…´è¶£: {travel_request.interests}
        - é¢å¤–ä¿¡æ¯: {travel_request.additional_info}
        
        è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¿›è¡Œç ”ç©¶ï¼š
        
        1. ä¸“æ³¨äºä¸»æµæ™¯ç‚¹å¹¶æä¾›æ·±æ€ç†Ÿè™‘çš„æŒ‡å¯¼ï¼š
           - è‘—ååœ°æ ‡å’Œçºªå¿µç¢‘
           - çƒ­é—¨æ—…æ¸¸æ™¯ç‚¹
           - çŸ¥ååšç‰©é¦†
           - ç»å…¸è´­ç‰©åŒº
           - å¸¸è§æ—…æ¸¸æ´»åŠ¨
        
        2. ç”¨ç®€å•çš„æ¨ç†æŒ‡å¯¼æ¸¸å®¢ï¼š
           - å»ºè®®å—å¤§ä¼—æ¬¢è¿çš„æ´»åŠ¨
           - ä¸“æ³¨äºå®¶åº­å‹å¥½çš„åœ°ç‚¹
           - æ¨èç»è¿‡éªŒè¯çš„æ—…æ¸¸è·¯çº¿
           - åŒ…æ‹¬çƒ­é—¨æ‹ç…§åœ°ç‚¹
        
        3. æä¾›æ¸…æ™°çš„æ™¯ç‚¹ä¿¡æ¯ï¼š
           - ç®€å•æè¿°
           - ä¸€èˆ¬ä½ç½®
           - å¸¸è§„å¼€æ”¾æ—¶é—´
           - æ ‡å‡†é—¨ç¥¨è´¹ç”¨
           - å…¸å‹æ¸¸è§ˆæ—¶é•¿
           - åŸºæœ¬æ¸¸å®¢æç¤º
        
        4. é€»è¾‘æ€§åœ°ç»„ç»‡ä¿¡æ¯ï¼š
           - ä¸»è¦æ™¯ç‚¹ä¼˜å…ˆ
           - å¸¸è§ä¸€æ—¥æ¸¸
           - æ ‡å‡†æ—…æ¸¸åŒº
           - çƒ­é—¨æ´»åŠ¨
        
        è¯·ä½¿ç”¨å·¥å…·æŸ¥æ‰¾å’ŒéªŒè¯æ—…æ¸¸ä¿¡æ¯ï¼Œä¿æŒå»ºè®®çš„ä¸€èˆ¬æ€§å’Œå¹¿æ³›å¸å¼•åŠ›ã€‚
        
        é¢„æœŸè¾“å‡ºæ ¼å¼ï¼š
        # æ—…æ¸¸æŒ‡å—
        ## ä¸»è¦æ™¯ç‚¹
        æœ€çƒ­é—¨æ—…æ¸¸æ™¯ç‚¹åˆ—è¡¨
        
        ## å¸¸è§æ´»åŠ¨
        æ ‡å‡†æ—…æ¸¸æ´»åŠ¨å’Œä½“éªŒ
        
        ## çƒ­é—¨åŒºåŸŸ
        çŸ¥ååœ°åŒºå’Œç¤¾åŒº
        
        ## åŸºæœ¬ä¿¡æ¯
        - ä¸€èˆ¬æ¸¸è§ˆæç¤º
        - å¸¸è§äº¤é€šé€‰é¡¹
        - æ ‡å‡†æ—…æ¸¸å»ºè®®
        """
        
        return base_prompt


class FlightNode(LangGraphNode):
    """èˆªç­æœç´¢èŠ‚ç‚¹"""
    
    def __init__(self):
        tools = get_all_tools(["flight_search", "web_search", "weather_search"])
        super().__init__(
            name="èˆªç­æœç´¢åŠ©æ‰‹",
            description="æ‚¨æ˜¯ä¸€ä¸ªç”¨äºå…¨é¢æ—…è¡Œè§„åˆ’çš„å¤æ‚èˆªç­æœç´¢å’Œåˆ†æåŠ©æ‰‹",
            tools=tools
        )
    
    def _build_prompt(self, state: TravelPlanState) -> str:
        """æ„å»ºèˆªç­æœç´¢æç¤ºè¯"""
        travel_request = state["travel_request"]
        
        base_prompt = f"""
        æ‚¨æ˜¯èˆªç­æœç´¢åŠ©æ‰‹ï¼Œç”¨äºå…¨é¢æ—…è¡Œè§„åˆ’çš„å¤æ‚èˆªç­æœç´¢å’Œåˆ†æã€‚
        
        ç”¨æˆ·æ—…è¡Œè¯·æ±‚ï¼š
        - å‡ºå‘åœ°: {travel_request.starting_location}
        - ç›®çš„åœ°: {travel_request.destination}
        - å‡ºå‘æ—¥æœŸ: {travel_request.travel_dates_start}
        - è¿”å›æ—¥æœŸ: {travel_request.travel_dates_end}
        - æ—…è¡Œäººæ•°: {travel_request.adults}ä¸ªæˆäºº, {travel_request.children}ä¸ªå„¿ç«¥
        - é¢„ç®—: {travel_request.budget} {travel_request.budget_currency}
        - æ—…è¡Œé£æ ¼: {travel_request.travel_style}
        
        è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¿›è¡Œèˆªç­æœç´¢ï¼š
        
        1. è§£æå®Œæ•´çš„èˆªç­è¦æ±‚ï¼ŒåŒ…æ‹¬ï¼š
           - å‡ºå‘å’Œç›®çš„åœ°åŸå¸‚
           - æ—…è¡Œæ—¥æœŸï¼ˆå‡ºå‘å’Œè¿”å›ï¼‰
           - æ—…è¡Œè€…æ•°é‡ï¼ˆæˆäººã€å„¿ç«¥ã€å©´å„¿ï¼‰
           - é¦–é€‰èˆ±ä½ç­‰çº§
           - ä»»ä½•ç‰¹å®šçš„èˆªç©ºå…¬å¸æˆ–è·¯çº¿åå¥½
           - å¦‚æœæŒ‡å®šï¼Œé¢„ç®—é™åˆ¶
        
        2. æœç´¢èˆªç­é€‰é¡¹ï¼š
           - ä½¿ç”¨flight_searchå·¥å…·è·å–èˆªç­ç»“æœ
           - è€ƒè™‘ç›´é£å’Œè½¬æœºèˆªç­
           - æ¯”è¾ƒä¸åŒçš„å‡ºå‘æ—¶é—´å’Œèˆªç©ºå…¬å¸
        
        3. å¯¹äºæ¯ä¸ªå¯è¡Œçš„èˆªç­é€‰é¡¹ï¼Œæå–ï¼š
           - å®Œæ•´çš„ä»·æ ¼åˆ†è§£ï¼ˆåŸºç¡€ç¥¨ä»·ã€ç¨è´¹ã€æ€»è®¡ï¼‰
           - èˆªç­å·å’Œè¿è¥èˆªç©ºå…¬å¸
           - è¯¦ç»†æ—¶é—´ï¼ˆå‡ºå‘ã€åˆ°è¾¾ã€æŒç»­æ—¶é—´ã€ä¸­è½¬ï¼‰
           - é£æœºç±»å‹å’Œå¯ç”¨è®¾æ–½
           - è¡Œæé™é¢å’Œæ”¿ç­–
        
        4. ç»„ç»‡å’Œå‘ˆç°é€‰é¡¹ï¼Œé‡ç‚¹å…³æ³¨ï¼š
           - æœ€ä½³æ€§ä»·æ¯”
           - ä¾¿åˆ©çš„æ—¶é—´å’Œæœ€å°‘ä¸­è½¬
           - æœåŠ¡è®°å½•è‰¯å¥½çš„å¯é èˆªç©ºå…¬å¸
           - çµæ´»æ€§å’Œé¢„è®¢æ¡ä»¶
        
        5. æä¾›å®ç”¨å»ºè®®ï¼Œè€ƒè™‘ï¼š
           - ä»·æ ¼è¶‹åŠ¿å’Œé¢„è®¢æ—¶æœº
           - å¦‚æœæœ‰ç›Šï¼Œæ›¿ä»£æ—¥æœŸæˆ–é™„è¿‘æœºåœº
           - å¦‚æœé€‚ç”¨ï¼Œå¿ è¯šåº¦è®¡åˆ’ç¦åˆ©
           - ç‰¹æ®Šè¦æ±‚ï¼ˆé¢å¤–è…¿éƒ¨ç©ºé—´ã€é¥®é£Ÿç­‰ï¼‰
        
        6. åŒ…å«é¢„è®¢æŒ‡å¯¼ï¼š
           - å¯ç”¨çš„ç›´æ¥é¢„è®¢é“¾æ¥
           - ç¥¨ä»·è§„åˆ™å’Œå˜æ›´æ”¿ç­–
           - æ‰€éœ€æ–‡ä»¶å’Œç­¾è¯å½±å“
        
        é¢„æœŸè¾“å‡ºæ ¼å¼ï¼š
        æ‰€æœ‰èˆªç­è¯¦æƒ…ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
        - flight_number (str): èˆªç­å·
        - price (str): èˆªç­ä»·æ ¼
        - airline (str): èˆªç©ºå…¬å¸
        - departure_time (str): å‡ºå‘æ—¶é—´
        - arrival_time (str): åˆ°è¾¾æ—¶é—´
        - duration (str): èˆªç­æŒç»­æ—¶é—´
        - stops (int): ä¸­è½¬æ¬¡æ•°
        """
        
        return base_prompt


class HotelNode(LangGraphNode):
    """é…’åº—æœç´¢èŠ‚ç‚¹"""
    
    def __init__(self):
        tools = get_all_tools(["hotel_search", "web_search", "weather_search"])
        super().__init__(
            name="é…’åº—æœç´¢åŠ©æ‰‹",
            description="ä¸“ä¸šçš„é…’åº—æœç´¢ä»£ç†ï¼Œä¸“æ³¨äºåŸºäºä½ç½®ã€é¢„ç®—å’Œè®¾æ–½å¯»æ‰¾å®Œç¾ä½å®¿",
            tools=tools
        )
    
    def _build_prompt(self, state: TravelPlanState) -> str:
        """æ„å»ºé…’åº—æœç´¢æç¤ºè¯"""
        travel_request = state["travel_request"]
        
        base_prompt = f"""
        æ‚¨æ˜¯é…’åº—æœç´¢åŠ©æ‰‹ï¼Œä¸“æ³¨äºåŸºäºä½ç½®ã€é¢„ç®—å’Œè®¾æ–½å¯»æ‰¾å®Œç¾ä½å®¿ã€‚
        
        ç”¨æˆ·æ—…è¡Œè¯·æ±‚ï¼š
        - ç›®çš„åœ°: {travel_request.destination}
        - å…¥ä½æ—¥æœŸ: {travel_request.travel_dates_start}
        - é€€æˆ¿æ—¥æœŸ: {travel_request.travel_dates_end}
        - æ—…è¡Œäººæ•°: {travel_request.adults}ä¸ªæˆäºº, {travel_request.children}ä¸ªå„¿ç«¥
        - æˆ¿é—´æ•°: {travel_request.rooms}
        - é¢„ç®—: {travel_request.budget} {travel_request.budget_currency}
        - æ—…è¡Œé£æ ¼: {travel_request.travel_style}
        - æ—…è¡Œæ°›å›´: {', '.join(travel_request.vibes)}
        
        è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¿›è¡Œé…’åº—æœç´¢ï¼š
        
        ä»»åŠ¡1ï¼šæŸ¥è¯¢å¤„ç†
        - ä»ç”¨æˆ·æŸ¥è¯¢ä¸­è§£æé…’åº—æœç´¢å‚æ•°
        - æå–ï¼š
          - ç›®çš„åœ°
          - å…¥ä½/é€€æˆ¿æ—¥æœŸ
          - å®¢äººæ•°é‡ï¼ˆæˆäººã€å„¿ç«¥ï¼‰
          - æˆ¿é—´è¦æ±‚
          - é¢„ç®—é™åˆ¶
          - é¦–é€‰è®¾æ–½
          - ä½ç½®åå¥½
        
        ä»»åŠ¡2ï¼šURLç”Ÿæˆå’Œåˆå§‹æŠ“å–
        - ä½¿ç”¨hotel_searchå·¥å…·ç”Ÿæˆæœç´¢URL
        - æ‰§è¡Œåˆå§‹å†…å®¹æŠ“å–
        - å¤„ç†ç›®çš„åœ°åç§°ä¸­ç‰¹æ®Šå­—ç¬¦çš„URLç¼–ç 
        
        ä»»åŠ¡3ï¼šæ•°æ®æå–
        - ä»æŠ“å–çš„å†…å®¹ä¸­è§£æé…’åº—åˆ—è¡¨
        - æå–å…³é”®è¯¦æƒ…ï¼š
          - ä»·æ ¼ï¼ˆåŒ…æ‹¬ç¨è´¹ï¼‰
          - è®¾æ–½ï¼ˆç‰¹åˆ«æ˜¯å®¶åº­å‹å¥½åŠŸèƒ½ï¼‰
          - è¯„åˆ†å’Œè¯„è®º
          - ä½ç½®è¯¦æƒ…
          - æˆ¿é—´ç±»å‹å’Œå¯ç”¨æ€§
          - å–æ¶ˆæ”¿ç­–
        - å¤„ç†ç»“æœçš„åŠ¨æ€åŠ è½½
        - å¦‚éœ€è¦ï¼Œå¯¼èˆªå¤šä¸ªé¡µé¢
        
        ä»»åŠ¡4ï¼šæ•°æ®å¤„ç†
        - æ„å»ºæå–çš„é…’åº—æ•°æ®
        - éªŒè¯æ•°æ®å®Œæ•´æ€§
        - åŸºäºä»¥ä¸‹æ¡ä»¶è¿‡æ»¤ç»“æœï¼š
          - é¢„ç®—é™åˆ¶
          - æ‰€éœ€è®¾æ–½
          - ä½ç½®åå¥½
          - å®¶åº­å‹å¥½åŠŸèƒ½
        
        ä»»åŠ¡5ï¼šç»“æœå±•ç¤º
        - æ¸…æ™°åœ°æ ¼å¼åŒ–ç»“æœï¼ŒåŒ…æ‹¬ï¼š
          - é…’åº—åç§°å’Œè¯„åˆ†
          - ä»·æ ¼åˆ†è§£
          - ä½ç½®å’Œå¯è¾¾æ€§
          - å…³é”®è®¾æ–½
          - å®¶åº­å‹å¥½åŠŸèƒ½
          - é¢„è®¢æ”¿ç­–
        - æŒ‰ä¸ç”¨æˆ·åå¥½çš„ç›¸å…³æ€§æ’åºç»“æœ
        - åŒ…å«ç›´æ¥é¢„è®¢é“¾æ¥
        
        é¢„æœŸè¾“å‡ºæ ¼å¼ï¼š
        é…’åº—åˆ—è¡¨ï¼Œæ¯ä¸ªé…’åº—åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
        - hotel_name (str): é…’åº—åç§°
        - price (str): é…’åº—ä»·æ ¼
        - rating (str): é…’åº—è¯„åˆ†
        - address (str): é…’åº—åœ°å€
        - amenities (List[str]): é…’åº—è®¾æ–½
        - description (str): é…’åº—æè¿°
        - url (str): é…’åº—URL
        """
        
        return base_prompt


class DiningNode(LangGraphNode):
    """é¤é¥®æœç´¢èŠ‚ç‚¹"""
    
    def __init__(self):
        tools = get_all_tools(["restaurant_search", "web_search", "weather_search"])
        super().__init__(
            name="ç¾é£ŸæŒ‡å—",
            description="å½“å›¢é˜Ÿè´Ÿè´£äººåˆ†é…ä»»åŠ¡æ—¶ï¼Œæ‚¨ç ”ç©¶é¤å…ã€é£Ÿå“å¸‚åœºã€ç¾é£Ÿä½“éªŒå’Œé¤é¥®é€‰é¡¹",
            tools=tools
        )
    
    def _build_prompt(self, state: TravelPlanState) -> str:
        """æ„å»ºé¤é¥®æœç´¢æç¤ºè¯"""
        travel_request = state["travel_request"]
        
        base_prompt = f"""
        æ‚¨æ˜¯ç¾é£ŸæŒ‡å—ï¼Œå½“å›¢é˜Ÿè´Ÿè´£äººåˆ†é…ä»»åŠ¡æ—¶ï¼Œæ‚¨ç ”ç©¶é¤å…ã€é£Ÿå“å¸‚åœºã€ç¾é£Ÿä½“éªŒå’Œé¤é¥®é€‰é¡¹ã€‚
        
        ç”¨æˆ·æ—…è¡Œè¯·æ±‚ï¼š
        - ç›®çš„åœ°: {travel_request.destination}
        - æ—…è¡Œæ—¥æœŸ: {travel_request.travel_dates_start} åˆ° {travel_request.travel_dates_end}
        - æ—…è¡Œäººæ•°: {travel_request.adults}ä¸ªæˆäºº, {travel_request.children}ä¸ªå„¿ç«¥
        - é¢„ç®—: {travel_request.budget} {travel_request.budget_currency}
        - æ—…è¡Œé£æ ¼: {travel_request.travel_style}
        - æ—…è¡Œæ°›å›´: {', '.join(travel_request.vibes)}
        - ä¼˜å…ˆçº§: {', '.join(travel_request.priorities)}
        - å…´è¶£: {travel_request.interests}
        
        è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¿›è¡Œé¤é¥®ç ”ç©¶ï¼š
        
        ä»»åŠ¡1ï¼šæŸ¥è¯¢å¤„ç†
        - ä»ç”¨æˆ·æŸ¥è¯¢ä¸­è§£æé¤é¥®åå¥½
        - æå–ï¼š
          - ä½ç½®/åŒºåŸŸ
          - èœç³»åå¥½
          - é¥®é£Ÿé™åˆ¶
          - é¢„ç®—èŒƒå›´
          - ç”¨é¤æ—¶é—´
          - å›¢é˜Ÿè§„æ¨¡
          - ç‰¹æ®Šè¦æ±‚ï¼ˆä¾‹å¦‚ï¼Œå®¶åº­å‹å¥½ã€æµªæ¼«ï¼‰
        
        ä»»åŠ¡2ï¼šç ”ç©¶å’Œæ•°æ®æ”¶é›†
        - ä½¿ç”¨restaurant_searchå·¥å…·æœç´¢é¤å…å’Œç¾é£Ÿä½“éªŒ
        - æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š
          - å½“åœ°èœç³»ç‰¹è‰²
          - çƒ­é—¨é£Ÿå“å¸‚åœº
          - ç¾é£Ÿä½“éªŒ
          - è¥ä¸šæ—¶é—´
          - ä»·æ ¼èŒƒå›´
          - é¢„è®¢æ”¿ç­–
        
        ä»»åŠ¡3ï¼šå†…å®¹åˆ†æ
        - åˆ†æé¤å…è¯„è®ºå’Œè¯„åˆ†
        - è¯„ä¼°ï¼š
          - é£Ÿç‰©è´¨é‡
          - æœåŠ¡æ ‡å‡†
          - æ°›å›´
          - æ€§ä»·æ¯”
          - é¥®é£Ÿé€‚åº”æ€§
          - å®¶åº­å‹å¥½æ€§
        
        ä»»åŠ¡4ï¼šæ•°æ®å¤„ç†
        - åŸºäºä»¥ä¸‹æ¡ä»¶è¿‡æ»¤ç»“æœï¼š
          - é¥®é£Ÿè¦æ±‚
          - é¢„ç®—é™åˆ¶
          - ä½ç½®åå¥½
          - ç‰¹æ®Šè¦æ±‚
        - éªŒè¯ä¿¡æ¯å®Œæ•´æ€§
        
        ä»»åŠ¡5ï¼šç»“æœå±•ç¤º
        ä»¥æ¸…æ™°ã€æœ‰ç»„ç»‡çš„å½¢å¼å‘ˆç°æ¨èï¼š
        
        é¤å…æ¨è
        å¯¹äºæ¯ä¸ªé¤å…ï¼ŒåŒ…æ‹¬ï¼š
        - åç§°å’Œèœç³»ç±»å‹
        - ä»·æ ¼èŒƒå›´ï¼ˆä¾‹å¦‚ï¼Œ$ã€$$ã€$$$ï¼‰
        - è¯„åˆ†å’Œç®€è¦è¯„è®ºæ‘˜è¦
        - ä½ç½®å’Œå¯è¾¾æ€§
        - è¥ä¸šæ—¶é—´
        - å¯ç”¨çš„é¥®é£Ÿé€‰é¡¹
        - ç‰¹æ®ŠåŠŸèƒ½ï¼ˆä¾‹å¦‚ï¼Œæˆ·å¤–åº§ä½ã€æ™¯è§‚ï¼‰
        - é¢„è®¢è¦æ±‚
        - å€¼å¾—å°è¯•çš„çƒ­é—¨èœè‚´
        
        é£Ÿå“å¸‚åœºå’Œç¾é£Ÿä½“éªŒ
        - å¸‚åœºåç§°å’Œç‰¹è‰²
        - æœ€ä½³è®¿é—®æ—¶é—´
        - å¿…å°çš„å½“åœ°ç¾é£Ÿ
        - æ–‡åŒ–æ„ä¹‰
        
        é™„åŠ ä¿¡æ¯
        - å½“åœ°ç¾é£Ÿä¹ ä¿—å’Œç¤¼ä»ª
        - è¦é¿å…çš„é«˜å³°ç”¨é¤æ—¶é—´
        - äº¤é€šé€‰é¡¹
        - é£Ÿå“å®‰å…¨æç¤º
        
        ä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œè¦ç‚¹æ ¼å¼åŒ–è¾“å‡ºï¼Œä»¥æé«˜å¯è¯»æ€§ã€‚
        
        é¢„æœŸè¾“å‡ºæ ¼å¼ï¼š
        ä»¥æ¸…æ™°ã€æœ‰ç»„ç»‡çš„å½¢å¼å‘ˆç°é¤é¥®æ¨èï¼ŒåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š
        
        # ğŸ½ï¸ é¤å…æ¨è
        å¯¹äºæ¯ä¸ªæ¨èçš„é¤å…ï¼š
        - åç§°å’Œèœç³»ç±»å‹
        - ä»·æ ¼èŒƒå›´å’Œä»·å€¼è¯„åˆ†
        - ä½ç½®å’Œå¯è¾¾æ€§
        - è¥ä¸šæ—¶é—´
        - é¥®é£Ÿé€‰é¡¹
        - ç‰¹æ®ŠåŠŸèƒ½
        - çƒ­é—¨èœè‚´
        - é¢„è®¢ä¿¡æ¯
        
        # ğŸ›ï¸ é£Ÿå“å¸‚åœºå’Œä½“éªŒ
        - å¸‚åœºåç§°å’Œç‰¹è‰²
        - æœ€ä½³è®¿é—®æ—¶é—´
        - å½“åœ°ç¾é£Ÿäº®ç‚¹
        - æ–‡åŒ–æ„ä¹‰
        
        # â„¹ï¸ é™„åŠ ä¿¡æ¯
        - å½“åœ°ä¹ ä¿—
        - é«˜å³°æ—¶é—´
        - äº¤é€š
        - å®‰å…¨æç¤º
        
        ä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œæ¸…æ™°çš„æ ¼å¼ä»¥æé«˜å¯è¯»æ€§ã€‚
        """
        
        return base_prompt


class ItineraryNode(LangGraphNode):
    """è¡Œç¨‹è§„åˆ’èŠ‚ç‚¹"""
    
    def __init__(self):
        tools = get_all_tools(["web_search", "attraction_search", "weather_search", "restaurant_search"])
        super().__init__(
            name="è¡Œç¨‹ä¸“å®¶",
            description="æ‚¨æ˜¯ä¸€ä½è¡Œç¨‹åˆ¶ä½œå¤§å¸ˆï¼Œæ“…é•¿åˆ¶ä½œè¯¦ç»†ã€å®Œç¾å®šæ—¶çš„æ¯æ—¥æ—…è¡Œè®¡åˆ’ã€‚æ‚¨å°†æŠ½è±¡çš„æ—…è¡Œç»†èŠ‚è½¬åŒ–ä¸ºç»“æ„åŒ–çš„ã€é€å°æ—¶çš„è®¡åˆ’ï¼Œåœ¨ä¿æŒç°å®èŠ‚å¥çš„åŒæ—¶æœ€å¤§åŒ–äº«å—ã€‚",
            tools=tools
        )
    
    def _build_prompt(self, state: TravelPlanState) -> str:
        """æ„å»ºè¡Œç¨‹è§„åˆ’æç¤ºè¯"""
        travel_request = state["travel_request"]
        
        base_prompt = f"""
        æ‚¨æ˜¯è¡Œç¨‹ä¸“å®¶ï¼Œæ“…é•¿åˆ¶ä½œè¯¦ç»†ã€å®Œç¾å®šæ—¶çš„æ¯æ—¥æ—…è¡Œè®¡åˆ’ã€‚
        
        ç”¨æˆ·æ—…è¡Œè¯·æ±‚ï¼š
        - ç›®çš„åœ°: {travel_request.destination}
        - å‡ºå‘åœ°: {travel_request.starting_location}
        - æ—…è¡Œæ—¥æœŸ: {travel_request.travel_dates_start} åˆ° {travel_request.travel_dates_end}
        - æŒç»­æ—¶é—´: {travel_request.duration}å¤©
        - æ—…è¡Œäººæ•°: {travel_request.adults}ä¸ªæˆäºº, {travel_request.children}ä¸ªå„¿ç«¥
        - é¢„ç®—: {travel_request.budget} {travel_request.budget_currency}
        - æ—…è¡Œé£æ ¼: {travel_request.travel_style}
        - æ—…è¡Œæ°›å›´: {', '.join(travel_request.vibes)}
        - ä¼˜å…ˆçº§: {', '.join(travel_request.priorities)}
        - å…´è¶£: {travel_request.interests}
        - èŠ‚å¥: {travel_request.pace}
        - é¢å¤–ä¿¡æ¯: {travel_request.additional_info}
        
        è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚åˆ›å»ºè¡Œç¨‹ï¼š
        
        1. åˆ›å»ºå®Œç¾å¹³è¡¡çš„é€æ—¥è¡Œç¨‹ï¼Œå…·æœ‰ç»†è‡´çš„æ—¶é—´å®‰æ’ï¼š
           - å°†æ¯ä¸€å¤©ç»“æ„åŒ–ä¸ºä¸Šåˆã€ä¸‹åˆå’Œæ™šä¸Šæ—¶æ®µ
           - ä¸ºæ¯ä¸ªæ´»åŠ¨åŒ…å«ç¡®åˆ‡æ—¶é—´ï¼ˆå¼€å§‹/ç»“æŸæ—¶é—´ï¼‰
           - è€ƒè™‘åœ°ç‚¹ä¹‹é—´çš„ç°å®æ—…è¡Œæ—¶é—´
           - å¹³è¡¡è§‚å…‰ä¸ä¼‘é—²å’Œä¼‘æ¯æ—¶é—´
           - è°ƒæ•´èŠ‚å¥ä»¥åŒ¹é…æ—…è¡Œè€…åå¥½ï¼ˆè½»æ¾ã€ä¸­ç­‰ã€å¿«é€Ÿï¼‰
        
        2. ç¡®ä¿æ‰€æœ‰æ—¶é—´è¡¨çš„å®ç”¨ç‰©æµï¼š
           - éªŒè¯æ‰€æœ‰æ™¯ç‚¹ã€é¤å…å’ŒæœåŠ¡çš„è¥ä¸šæ—¶é—´
           - è€ƒè™‘å¸¸è§å»¶è¯¯ï¼ˆå®‰æ£€é˜Ÿä¼ã€äººç¾¤ã€äº¤é€šï¼‰
           - åœ¨æ´»åŠ¨ä¹‹é—´åŒ…å«ç¼“å†²æ—¶é—´
           - æ£€æŸ¥ç‰¹å®šæ—¥æœŸçš„å…³é—­ï¼ˆå‘¨æœ«ã€èŠ‚å‡æ—¥ã€å­£èŠ‚æ€§ï¼‰
           - è€ƒè™‘å½“åœ°äº¤é€šé€‰é¡¹å’Œæ—¶é—´è¡¨
        
        3. ç”¨ä¸“ä¸šçŸ¥è¯†ä¼˜åŒ–æ´»åŠ¨æ—¶é—´ï¼š
           - å°½å¯èƒ½åœ¨éé«˜å³°æ—¶é—´å®‰æ’è®¿é—®
           - åœ¨å¯èƒ½ä¸‹é›¨/ç‚çƒ­çš„æ—¶æœŸè®¡åˆ’å®¤å†…æ´»åŠ¨
           - åœ¨æœ€ä½³æ—¶é—´å®‰æ’æ—¥å‡º/æ—¥è½ä½“éªŒ
           - åœ¨å½“åœ°ä¼ ç»Ÿç”¨é¤æ—¶é—´å®‰æ’ç”¨é¤
           - å®‰æ’æ´»åŠ¨æ—¶é—´ä»¥é¿å…é«˜å³°æ—¶æ®µäº¤é€š
        
        4. ä¸ºç‰¹å®šæ—…è¡Œè€…ç±»å‹åˆ›å»ºå®šåˆ¶æ—¶é—´è¡¨ï¼š
           - å®¶åº­ï¼šåŒ…æ‹¬å„¿ç«¥å‹å¥½çš„ä¼‘æ¯å’Œæ—©æ™šé¤
           - è€å¹´äººï¼šæ›´è½»æ¾çš„èŠ‚å¥ï¼Œå……è¶³çš„ä¼‘æ¯æ—¶é—´
           - å¹´è½»äººï¼šè¾ƒæ™šçš„å¼€å§‹æ—¶é—´å’Œæ™šé—´æ´»åŠ¨
           - è±ªåæ—…è¡Œè€…ï¼šç‹¬å®¶ä½“éªŒçš„æ—¶é—´å®‰æ’
           - å•†åŠ¡æ—…è¡Œè€…ï¼šå›´ç»•å·¥ä½œæ‰¿è¯ºçš„é«˜æ•ˆæ—¶é—´å®‰æ’
        
        5. ç”¨å®ç”¨æ—¶é—´è¯¦æƒ…å¢å¼ºè¡Œç¨‹ï¼š
           - é¿å…æ™¯ç‚¹æ’é˜Ÿçš„æœ€ä½³åˆ°è¾¾æ—¶é—´
           - æœ€ä½³å…‰ç…§çš„æ‘„å½±æ—¶é—´
           - å›´ç»•æ´»åŠ¨å®‰æ’ç”¨é¤é¢„è®¢æ—¶é—´
           - å½“åœ°å¸‚åœºå’Œå•†åº—çš„è´­ç‰©æ—¶é—´
           - ä¾èµ–å¤©æ°”çš„å¤‡ç”¨è®¡åˆ’
        
        6. ç ”ç©¶å·¥å…·ä½¿ç”¨ä»¥è¿›è¡Œå‡†ç¡®çš„æ—¶é—´å®‰æ’ï¼š
           - ä½¿ç”¨web_searchç ”ç©¶ç‰¹å®šåœ°ç‚¹çš„æ—¶é—´ä¿¡æ¯
           - ä½¿ç”¨attraction_searchè·å–å½“å‰è¥ä¸šæ—¶é—´å’Œæ¡ä»¶
           - ä½¿ç”¨weather_searchä¼˜åŒ–æ´»åŠ¨é¡ºåºå’Œæ—¶é—´
        
        7. ä»¥æœ€å¤§æ¸…æ™°åº¦æ ¼å¼åŒ–æ¯æ—¥è®¡åˆ’ï¼š
           - ä½¿ç”¨æ¸…æ™°çš„æ—¶é—´å—ï¼ˆä¸Šåˆ8:00 - ä¸Šåˆ9:30ï¼‰
           - åŒ…å«åœ°ç‚¹ä¹‹é—´çš„æ—…è¡Œæ–¹å¼å’ŒæŒç»­æ—¶é—´
           - çªå‡ºé¢„è®¢æ—¶é—´å’Œé¢„è®¢è¦æ±‚
           - æ³¨æ„æ‰€éœ€çš„æå‰åˆ°è¾¾æ—¶é—´ï¼ˆå®‰æ£€ã€å…¥ä½ï¼‰
           - ä½¿ç”¨è¡¨æƒ…ç¬¦å·ä»¥è·å¾—æ›´å¥½çš„è§†è§‰ç»„ç»‡
        
        å…¶ä»–ä»£ç†çš„ç ”ç©¶ç»“æœï¼š
        """
        
        # æ·»åŠ å…¶ä»–ä»£ç†çš„ç»“æœ
        if state.get("destination_result"):
            base_prompt += f"\nç›®çš„åœ°ç ”ç©¶: {state['destination_result'].content[:500]}...\n"
        
        if state.get("flight_result"):
            base_prompt += f"\nèˆªç­ä¿¡æ¯: {state['flight_result'].content[:500]}...\n"
        
        if state.get("hotel_result"):
            base_prompt += f"\né…’åº—ä¿¡æ¯: {state['hotel_result'].content[:500]}...\n"
        
        if state.get("dining_result"):
            base_prompt += f"\né¤é¥®ä¿¡æ¯: {state['dining_result'].content[:500]}...\n"
        
        base_prompt += """
        
        è¯·åŸºäºä»¥ä¸Šä¿¡æ¯åˆ›å»ºè¯¦ç»†çš„é€æ—¥è¡Œç¨‹å®‰æ’ã€‚
        
        é¢„æœŸè¾“å‡ºæ ¼å¼ï¼š
        # è¯¦ç»†è¡Œç¨‹ï¼š{ç›®çš„åœ°} ({å¼€å§‹æ—¥æœŸ} - {ç»“æŸæ—¥æœŸ})
        
        ## æ—…è¡Œæ¦‚è§ˆ
        - **æ—¥æœŸ**ï¼š{ç¡®åˆ‡æ—¥æœŸå’Œå¤©æ•°}
        - **æ—…è¡Œè€…**ï¼š{æ•°é‡å’Œç±»å‹}
        - **èŠ‚å¥**ï¼š{è½»æ¾/ä¸­ç­‰/å¿«é€Ÿ}
        - **é£æ ¼**ï¼š{è±ªå/ä¸­æ¡£/é¢„ç®—}
        - **ä¼˜å…ˆçº§**ï¼š{å…³é”®å…´è¶£å’Œç›®æ ‡}
        
        ## ç¬¬1å¤©ï¼š{æ˜ŸæœŸå‡ }ï¼Œ{æ—¥æœŸ}
        ### ä¸Šåˆ
        - **ä¸Šåˆ7:00 - ä¸Šåˆ8:00**ï¼šåœ¨{åœ°ç‚¹}ç”¨æ—©é¤
        - **ä¸Šåˆ8:30 - ä¸Šåˆ10:30**ï¼šåœ¨{åœ°ç‚¹}è¿›è¡Œ{æ´»åŠ¨}
          * å¤‡æ³¨ï¼š{ç‰¹æ®Šè¯´æ˜ï¼Œæ—¶é—´æç¤º}
          * äº¤é€šï¼š{äº¤é€šæ–¹å¼ï¼ŒæŒç»­æ—¶é—´}
        - **ä¸Šåˆ11:00 - ä¸‹åˆ12:30**ï¼šåœ¨{åœ°ç‚¹}è¿›è¡Œ{æ´»åŠ¨}
          * å¤‡æ³¨ï¼š{ç‰¹æ®Šè¯´æ˜ï¼Œæ—¶é—´æç¤º}
          * äº¤é€šï¼š{äº¤é€šæ–¹å¼ï¼ŒæŒç»­æ—¶é—´}
        
        ### ä¸‹åˆ
        - **ä¸‹åˆ1:00 - ä¸‹åˆ2:00**ï¼šåœ¨{åœ°ç‚¹}ç”¨åˆé¤
        - **ä¸‹åˆ2:30 - ä¸‹åˆ4:30**ï¼šåœ¨{åœ°ç‚¹}è¿›è¡Œ{æ´»åŠ¨}
          * å¤‡æ³¨ï¼š{ç‰¹æ®Šè¯´æ˜ï¼Œæ—¶é—´æç¤º}
          * äº¤é€šï¼š{äº¤é€šæ–¹å¼ï¼ŒæŒç»­æ—¶é—´}
        - **ä¸‹åˆ5:00 - ä¸‹åˆ6:00**ï¼šåœ¨é…’åº—ä¼‘æ¯/æ¢å¤
        
        ### æ™šä¸Š
        - **æ™šä¸Š7:00 - æ™šä¸Š8:30**ï¼šåœ¨{åœ°ç‚¹}ç”¨æ™šé¤
        - **æ™šä¸Š9:00 - æ™šä¸Š10:30**ï¼šåœ¨{åœ°ç‚¹}è¿›è¡Œ{æ´»åŠ¨}
          * å¤‡æ³¨ï¼š{ç‰¹æ®Šè¯´æ˜ï¼Œæ—¶é—´æç¤º}
          * äº¤é€šï¼š{äº¤é€šæ–¹å¼ï¼ŒæŒç»­æ—¶é—´}
        
        ## ç¬¬2å¤©ï¼š{æ˜ŸæœŸå‡ }ï¼Œ{æ—¥æœŸ}
        [ç±»ä¼¼çš„è¯¦ç»†åˆ†è§£]
        
        [ç»§ç»­æ—…è¡Œçš„æ¯ä¸€å¤©]
        
        ## å®ç”¨å¤‡æ³¨
        - **å¤©æ°”è€ƒè™‘**ï¼š{ä¸å¤©æ°”ç›¸å…³çš„æ—¶é—´è°ƒæ•´}
        - **äº¤é€šæç¤º**ï¼š{å½“åœ°äº¤é€šæ—¶é—´å»ºè®®}
        - **é¢„è®¢æé†’**ï¼š{æ‰€æœ‰é¢„å®šçš„æ—¶é—´}
        - **å¤‡ç”¨è®¡åˆ’**ï¼š{å¤©æ°”/å…³é—­çš„æ›¿ä»£æ—¶é—´è¡¨}
        """
        
        return base_prompt


class BudgetNode(LangGraphNode):
    """é¢„ç®—ä¼˜åŒ–èŠ‚ç‚¹"""
    
    def __init__(self):
        tools = get_all_tools(["web_search", "hotel_search", "flight_search", "restaurant_search"])
        super().__init__(
            name="é¢„ç®—ä¼˜åŒ–å™¨",
            description="å½“å›¢é˜Ÿè´Ÿè´£äººåˆ†é…ä»»åŠ¡æ—¶ï¼Œæ‚¨ç ”ç©¶æˆæœ¬ã€æ¯”è¾ƒä»·æ ¼å¹¶ä¼˜åŒ–æ—…è¡Œé¢„ç®—ã€‚å½“è®¡åˆ’è¶…å‡ºé¢„ç®—æ—¶ï¼Œæ‚¨å»ºè®®æˆ˜ç•¥æ€§è°ƒæ•´ä»¥ä½¿æˆæœ¬ç¬¦åˆé¢„ç®—ï¼ŒåŒæ—¶ä¿æŒæ ¸å¿ƒæ—…è¡Œä½“éªŒã€‚",
            tools=tools
        )
    
    def _build_prompt(self, state: TravelPlanState) -> str:
        """æ„å»ºé¢„ç®—ä¼˜åŒ–æç¤ºè¯"""
        travel_request = state["travel_request"]
        
        base_prompt = f"""
        æ‚¨æ˜¯é¢„ç®—ä¼˜åŒ–å™¨ï¼Œå½“å›¢é˜Ÿè´Ÿè´£äººåˆ†é…ä»»åŠ¡æ—¶ï¼Œæ‚¨ç ”ç©¶æˆæœ¬ã€æ¯”è¾ƒä»·æ ¼å¹¶ä¼˜åŒ–æ—…è¡Œé¢„ç®—ã€‚
        
        ç”¨æˆ·æ—…è¡Œè¯·æ±‚ï¼š
        - ç›®çš„åœ°: {travel_request.destination}
        - å‡ºå‘åœ°: {travel_request.starting_location}
        - æ—…è¡Œæ—¥æœŸ: {travel_request.travel_dates_start} åˆ° {travel_request.travel_dates_end}
        - æŒç»­æ—¶é—´: {travel_request.duration}å¤©
        - æ—…è¡Œäººæ•°: {travel_request.adults}ä¸ªæˆäºº, {travel_request.children}ä¸ªå„¿ç«¥
        - é¢„ç®—: {travel_request.budget} {travel_request.budget_currency}
        - æ—…è¡Œé£æ ¼: {travel_request.travel_style}
        - é¢„ç®—çµæ´»: {travel_request.budget_flexible}
        - æ—…è¡Œæ°›å›´: {', '.join(travel_request.vibes)}
        - ä¼˜å…ˆçº§: {', '.join(travel_request.priorities)}
        - å…´è¶£: {travel_request.interests}
        
        è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¿›è¡Œé¢„ç®—ä¼˜åŒ–ï¼š
        
        1. åˆ†ææ€»é¢„ç®—å’Œæˆæœ¬è¦æ±‚ï¼š
           - å®¡æŸ¥æ€»é¢„ç®—é™åˆ¶
           - è®¡ç®—äº¤é€šã€ä½å®¿ã€æ´»åŠ¨ã€é¤é¥®æˆæœ¬
           - è¯†åˆ«ä»»ä½•è¶…å‡ºé¢„ç®—çš„ç»„æˆéƒ¨åˆ†
        
        2. å¦‚æœè¶…å‡ºé¢„ç®—ï¼Œå»ºè®®èŠ‚çœæˆæœ¬çš„æ›¿ä»£æ–¹æ¡ˆï¼š
           - æ›¿ä»£ä½å®¿æˆ–åœ°ç‚¹
           - ä¸åŒçš„äº¤é€šé€‰é¡¹
           - é«˜ç«¯å’Œé¢„ç®—ä½“éªŒçš„æ··åˆ
           - å…è´¹æˆ–ä½æˆæœ¬æ´»åŠ¨æ›¿ä»£å“
           - é¢„ç®—å‹å¥½çš„é¤é¥®æ¨è
        
        3. ç ”ç©¶å¹¶æ¨èçœé’±ç­–ç•¥ï¼š
           - æå‰é¢„è®¢æŠ˜æ‰£
           - å¥—é¤ä¼˜æƒ 
           - æ·¡å­£å®šä»·
           - å½“åœ°é€šè¡Œè¯å’ŒæŠ˜æ‰£å¡
        
        4. å‘ˆç°æ¸…æ™°çš„é¢„ç®—åˆ†è§£ï¼Œæ˜¾ç¤ºï¼š
           - åŸå§‹æˆæœ¬ä¸ä¼˜åŒ–æˆæœ¬
           - æ¯ä¸ªç±»åˆ«çš„å…·ä½“èŠ‚çœ
           - æ›¿ä»£é€‰é¡¹
           - éšè—æˆæœ¬è­¦å‘Š
        
        æ‰€æœ‰ä»£ç†çš„ç ”ç©¶ç»“æœï¼š
        """
        
        # æ·»åŠ æ‰€æœ‰å…¶ä»–ä»£ç†çš„ç»“æœ
        for key, value in state.items():
            if key.endswith("_result") and value:
                base_prompt += f"\n{key}: {value.content[:300]}...\n"
        
        base_prompt += """
        
        è¯·åŸºäºä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯è¿›è¡Œé¢„ç®—ä¼˜åŒ–å’Œæˆæœ¬åˆ†æã€‚
        
        ä»¥ç”¨æˆ·é¦–é€‰çš„è´§å¸æ ¼å¼åŒ–æ‰€æœ‰é‡‘é¢ï¼Œå¹¶åœ¨åŸå§‹é¢„ç®—å’Œä¼˜åŒ–é¢„ç®—ä¹‹é—´è¿›è¡Œæ¸…æ™°æ¯”è¾ƒã€‚
        
        é¢„æœŸè¾“å‡ºæ ¼å¼ï¼š
        # é¢„ç®—ä¼˜åŒ–åˆ†æ
        
        ## æ€»é¢„ç®—æ¦‚è§ˆ
        - åŸå§‹é¢„ç®—: {é¢„ç®—é‡‘é¢} {è´§å¸}
        - é¢„è®¡æ€»æˆæœ¬: {é¢„è®¡æˆæœ¬} {è´§å¸}
        - é¢„ç®—å·®å¼‚: {å·®å¼‚é‡‘é¢} {è´§å¸}
        
        ## æˆæœ¬åˆ†è§£
        ### äº¤é€šè´¹ç”¨
        - èˆªç­: {èˆªç­è´¹ç”¨}
        - å½“åœ°äº¤é€š: {äº¤é€šè´¹ç”¨}
        - æ€»è®¡: {äº¤é€šæ€»è®¡}
        
        ### ä½å®¿è´¹ç”¨
        - é…’åº—: {é…’åº—è´¹ç”¨}
        - æ€»è®¡: {ä½å®¿æ€»è®¡}
        
        ### é¤é¥®è´¹ç”¨
        - é¤å…: {é¤é¥®è´¹ç”¨}
        - æ€»è®¡: {é¤é¥®æ€»è®¡}
        
        ### æ´»åŠ¨è´¹ç”¨
        - æ™¯ç‚¹é—¨ç¥¨: {é—¨ç¥¨è´¹ç”¨}
        - æ´»åŠ¨: {æ´»åŠ¨è´¹ç”¨}
        - æ€»è®¡: {æ´»åŠ¨æ€»è®¡}
        
        ## ä¼˜åŒ–å»ºè®®
        - èŠ‚çœæœºä¼š: {èŠ‚çœå»ºè®®}
        - æ›¿ä»£æ–¹æ¡ˆ: {æ›¿ä»£é€‰é¡¹}
        - éšè—æˆæœ¬: {éšè—æˆæœ¬è­¦å‘Š}
        
        ## æœ€ç»ˆé¢„ç®—
        - ä¼˜åŒ–åæ€»æˆæœ¬: {æœ€ç»ˆæˆæœ¬} {è´§å¸}
        - é¢„ç®—åˆ©ç”¨ç‡: {åˆ©ç”¨ç‡}%
        - å‰©ä½™é¢„ç®—: {å‰©ä½™é‡‘é¢} {è´§å¸}
        """
        
        return base_prompt


# åˆ›å»ºèŠ‚ç‚¹å®ä¾‹
destination_node = DestinationNode()
flight_node = FlightNode()
hotel_node = HotelNode()
dining_node = DiningNode()
itinerary_node = ItineraryNode()
budget_node = BudgetNode()
